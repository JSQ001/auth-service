<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hand.hcf.app.base.user.persistence.UserTempMapper">

    <insert id="insertToContact">
        INSERT INTO sys_contact(
            ID,
            EMPLOYEE_ID,
            FULL_NAME,
            EMAIL,
            DIRECT_MANAGER,
            DUTY,
            DUTY_CODE,
            EMPLOYEE_TYPE,
            EMPLOYEE_TYPE_CODE,
            TITLE,
            RANK,
            RANK_CODE,
            GENDER,
            BIRTHDAY,
            ENTRY_DATE,
            SENIOR,
            version_number,
            created_date,
            created_by,
            last_updated_date,
            last_updated_by
        )
        SELECT
            t.ID,
            t.EMPLOYEE_ID,
            t.FULL_NAME,
            t.EMAIL,
            t.DIRECT_MANAGER,
            t.DUTY,
            t.DUTY_CODE,
            t.EMPLOYEE_TYPE,
            t.EMPLOYEE_TYPE_CODE,
            t.TITLE,
            t.RANK,
            t.RANK_CODE,
            t.GENDER,
            t.BIRTHDAY,
            t.ENTRY_DATE,
            0,
            1,
            #{currentDate},
            #{userId},
            #{currentDate},
            #{userId}
        FROM sys_user_import_temp t
        WHERE t.batch_number = #{batchNumber}
            AND t.error_flag = 0
    </insert>

    <insert id="insertToUser">
        INSERT INTO sys_user(
            ID,
            COMPANY_ID,
            CONTACT_ID,
            USER_OID,
            LOGIN,
            ACTIVATED,
            STATUS,
            TENANT_ID,
            DELETED,
            version_number,
            created_date,
            created_by,
            last_updated_date,
            last_updated_by
        ) SELECT
            t.ID,
            t.COMPANY_ID,
            t.ID,
            t.USER_OID,
            t.LOGIN,
            0,
            1001,
            #{tenantId},
            0,
            1,
            #{currentDate},
            #{userId},
            #{currentDate},
            #{userId}
        FROM sys_user_import_temp t
        WHERE t.batch_number = #{batchNumber}
            AND t.error_flag = 0
    </insert>

    <insert id="insertToPhone">
        INSERT INTO sys_phone(
            ID,
            CONTACT_ID,
            COUNTRY_CODE,
            PHONE_NUMBER,
            TYPE,
            IS_PRIMARY,
            version_number,
            created_date,
            created_by,
            last_updated_date,
            last_updated_by
        ) SELECT
            t.ID,
            t.ID,
            t.mobile_area_code,
            t.mobile,
            1001,
            1,
            1,
            #{currentDate},
            #{userId},
            #{currentDate},
            #{userId}
        FROM sys_user_import_temp t
        WHERE t.batch_number = #{batchNumber}
            AND t.mobile is not null
            AND t.error_flag = 0

    </insert>

    <insert id="insertToDepartmentUser">
        INSERT INTO sys_department_user(
            ID,
            USER_ID,
            DEPARTMENT_ID,
            version_number,
            created_date,
            created_by,
            last_updated_date,
            last_updated_by
        ) SELECT
            t.ID,
            t.ID,
            t.DEPARTMENT_ID,
            1,
            #{currentDate},
            #{userId},
            #{currentDate},
            #{userId}
        FROM sys_user_import_temp t
        WHERE t.batch_number = #{batchNumber}
            AND t.error_flag = 0
    </insert>

    <update id="updateEmployeeIdExists">
        UPDATE sys_user_import_temp t
        SET t.error_flag   = 1,
            t.error_detail = concat(error_detail,'当前工号已存在!')
        WHERE (EXISTS
             (SELECT 1
                FROM sys_contact c,sys_user u
               WHERE u.contact_id = c.id
                  AND u.status = 1001
                  AND c.employee_id = t.employee_id)
              OR EXISTS
             (SELECT 1
                FROM sys_user_import_temp t1
                WHERE t1.employee_id = t.employee_id
                AND t1.batch_number = t.batch_number
                AND t1.id != t.id))
        AND t.batch_number = #{batchNumber}
    </update>

    <update id="updateEmailExists">
        UPDATE sys_user_import_temp t
        SET t.error_flag = 1,
            t.error_detail = concat(error_detail,'当前邮箱已存在!')
        WHERE (EXISTS
             (SELECT 1
                FROM sys_contact c,sys_user u
               WHERE u.contact_id = c.id
                  AND u.status = 1001
                  AND c.email = t.email)
              OR EXISTS
             (SELECT 1
                FROM sys_user_import_temp t1
                WHERE t1.email = t.email
                AND t1.batch_number = t.batch_number
                AND t1.id != t.id))
        AND t.batch_number = #{batchNumber}
    </update>

    <update id="updatePhoneExists">
        UPDATE sys_user_import_temp t
        SET t.error_flag   = 1,
            t.error_detail = concat(error_detail,'当前手机已存在!')
        WHERE (EXISTS
             (SELECT 1
                FROM sys_user u,sys_contact c,sys_phone p
               WHERE u.contact_id = c.id
                  AND p.contact_id = c.id
                  AND u.status = 1001
                  AND p.phone_number = t.mobile)
              OR EXISTS
             (SELECT 1
                FROM sys_user_import_temp t1
                WHERE t1.mobile = t.mobile
                AND t1.batch_number = t.batch_number
                AND t1.id != t.id))
        AND t.batch_number = #{batchNumber}
    </update>

    <select id="queryInfo" resultMap="queryInfoMap">
        SELECT (SELECT
        COUNT(0) AS successEntities
        FROM sys_user_import_temp
        WHERE batch_number = #{transactionId}
        AND error_flag = 0) AS successEntities,
        (SELECT
        COUNT(0) AS failureEntities
        FROM sys_user_import_temp
        WHERE batch_number = #{transactionId}
        AND error_flag = 1) AS failureEntities,
        #{transactionId} AS transaction_id
        FROM dual

    </select>
    <resultMap id="queryInfoMap" type="com.hand.hcf.core.web.dto.ImportResultDTO">
        <result column="successEntities" property="successEntities"/>
        <result column="failureEntities" property="failureEntities"/>
        <collection property="errorData" select="queryErrorData"
                    column="{transactionId=transaction_id}"/>
    </resultMap>

    <select id="queryErrorData" resultMap="errorDataMap">
        select t.row_number AS row_number,
        t.error_detail AS error
        FROM sys_user_import_temp t
        WHERE t.batch_number = #{transactionId}
        AND t.error_flag = 1
    </select>
    <resultMap id="errorDataMap" type="com.hand.hcf.core.web.dto.ImportErrorDTO">
        <result column="row_number" property="index"/>
        <result column="error" property="error"/>
    </resultMap>

    <select id="varifyBatchNumberExsits" resultType="java.lang.Boolean">
        SELECT 1
        FROM dual
        WHERE EXISTS (SELECT 1
          FROM sys_user_import_temp
          WHERE batch_number = #{transactionId})
    </select>

    <select id="selectUserOidByEmployeeIdAndTenantId" resultType="java.util.UUID">
        SELECT u.user_oid
        FROM sys_contact c,sys_user u
        WHERE c.id = u.contact_id
          AND u.status != 1003
          AND c.employee_id = #{employeeId}
    </select>


</mapper>